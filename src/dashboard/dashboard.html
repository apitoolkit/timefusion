<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeFusion Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6/themes/light.css">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #4f46e5;
            --accent: #a5b4fc;
            --text: #111827;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.05);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --muted: #6b7280;
            --border: #e5e7eb;
            --alert-bg: #fefce8;
            --alert-border: #facc15;
        }
        [data-theme="dark"] {
            --primary: #818cf8;
            --secondary: #6366f1;
            --accent: #c7d2fe;
            --text: #e5e7eb;
            --bg: #1f2937;
            --card-bg: #374151;
            --shadow: rgba(0, 0, 0, 0.2);
            --muted: #9ca3af;
            --border: #4b5563;
            --alert-bg: #713f12;
            --alert-border: #facc15;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body {
            background: var(--bg);
            color: var(--text);
            padding: 2rem;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }
        header {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--primary);
        }
        .controls {
            display: flex;
            gap: 1rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }
        .btn:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px var(--shadow);
        }
        .stat-card h2 {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 0.75rem;
        }
        .stat-card p {
            font-size: 1.75rem;
            font-weight: 600;
        }
        .stat-card p.success { color: var(--success); }
        .stat-card p.warning { color: var(--warning); }
        .stat-card p.error { color: var(--error); }
        .trend {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 0.25rem;
        }
        .trend.up::before { content: "▲ "; color: var(--success); }
        .trend.down::before { content: "▼ "; color: var(--error); }
        .charts-grid, .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }
        .chart-container, .table-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px var(--shadow);
            position: relative;
        }
        .chart-container h2, .table-container h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }
        .filter-container {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        input[type="datetime-local"], input[type="text"] {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }
        input[type="datetime-local"]:focus, input[type="text"]:focus {
            border-color: var(--primary);
            outline: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }
        .pagination {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }
        .pagination button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .pagination button:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }
        .pagination button:hover:not(:disabled) {
            background: var(--secondary);
        }
        .export-btn {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: var(--accent);
            color: var(--text);
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        .export-btn:hover {
            background: var(--primary);
            color: white;
        }
        footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--muted);
            font-size: 0.875rem;
        }
        .alert {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--alert-bg);
            border: 1px solid var(--alert-border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            max-width: 320px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        .alert p {
            font-size: 0.875rem;
            color: var(--text);
            margin-bottom: 0.75rem;
        }
        .alert button {
            background: var(--warning);
            color: white;
            border: none;
            padding: 0.375rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s ease;
        }
        .alert button:hover {
            background: var(--secondary);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 768px) {
            body { padding: 1rem; }
            header { flex-direction: column; gap: 1rem; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
            .charts-grid, .tables-grid { grid-template-columns: 1fr; }
            .filter-container { flex-direction: column; }
            .alert { max-width: 90%; right: 1rem; top: 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>TimeFusion Dashboard</h1>
        <div class="controls">
            <button class="btn" id="refresh-btn">Refresh</button>
            <button class="btn" id="theme-toggle">Dark Mode</button>
        </div>
    </header>
    <main>
        <section class="stats-grid">
            <div class="stat-card" data-tippy-content="Application uptime in seconds">
                <h2>Uptime</h2>
                <p id="uptime">{{uptime}}</p>
                <span class="trend" id="uptime-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Total HTTP requests processed">
                <h2>Requests</h2>
                <p id="http_requests">{{http_requests}}</p>
                <span class="trend" id="requests-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Current ingestion queue size (Alert > 50)">
                <h2>Queue Size</h2>
                <p id="queue_size" class="{{queueAlert ? 'warning' : ''}}">{{queueSize}}</p>
                <span class="trend" id="queue-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Database health status">
                <h2>DB Status</h2>
                <p id="db_status" class="{{dbStatus}}">{{dbStatus}}</p>
            </div>
            <div class="stat-card" data-tippy-content="Ingestion rate (records/sec)">
                <h2>Ingestion Rate</h2>
                <p id="ingestion_rate">{{ingestionRate}}</p>
                <span class="trend" id="ingestion-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Average latency in milliseconds (Alert > 200ms)">
                <h2>Avg Latency</h2>
                <p id="avg_latency" class="{{latencyAlert ? 'warning' : ''}}">{{avgLatency}}</p>
                <span class="trend" id="latency-trend"></span>
            </div>
        </section>
        <section class="charts-grid">
            <div class="chart-container">
                <h2>Performance Trends</h2>
                <div class="filter-container">
                    <input type="datetime-local" id="trend-start" step="1">
                    <input type="datetime-local" id="trend-end" step="1">
                </div>
                <canvas id="trendChart" style="max-height: 350px;"></canvas>
            </div>
            <div class="chart-container">
                <h2>Ingestion Status</h2>
                <canvas id="statusChart" style="max-height: 350px;"></canvas>
            </div>
        </section>
        <section class="tables-grid">
            <div class="table-container">
                <h2>Recent Ingestion Statuses</h2>
                <div class="filter-container">
                    <input type="datetime-local" id="status-start" step="1">
                    <input type="datetime-local" id="status-end" step="1">
                </div>
                <input type="text" id="status-filter" placeholder="Filter by ID or Status">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="status-table"></tbody>
                </table>
                <div class="pagination" id="status-pagination"></div>
            </div>
            <div class="table-container">
                <h2>Recent Records</h2>
                <div class="filter-container">
                    <input type="datetime-local" id="records-start" step="1">
                    <input type="datetime-local" id="records-end" step="1">
                </div>
                <input type="text" id="records-filter" placeholder="Filter by Project ID or Timestamp">
                <table>
                    <thead>
                        <tr>
                            <th>Project ID</th>
                            <th>Record ID</th>
                            <th>Timestamp</th>
                            <th>Latency (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="records-table"></tbody>
                </table>
                <div class="pagination" id="records-pagination"></div>
                <button class="export-btn" id="export-btn">Export CSV</button>
            </div>
        </section>
    </main>
    <footer>
        <p>© 2025 TimeFusion</p>
    </footer>

    <script>
        // Initialize with server-rendered data
        const initialData = {
            recentStatuses: JSON.parse('{{recentStatuses}}' || '[]'),
            recentRecords: JSON.parse('{{recentRecords}}' || '[]'),
            statusCounts: JSON.parse('{{statusCounts}}' || '{"Success": 0, "Failed": 0, "Pending": 0}'),
            trends: JSON.parse('{{trends}}' || '[]')
        };

        document.addEventListener('DOMContentLoaded', () => {
            let prevData = {
                uptime: parseFloat('{{uptime}}') || 0,
                httpRequests: parseFloat('{{httpRequests}}') || 0,
                queueSize: parseFloat('{{queueSize}}') || 0,
                ingestionRate: parseFloat('{{ingestionRate}}') || 0,
                avgLatency: parseFloat('{{avgLatency}}') || 0,
                queueAlert: '{{queueAlert}}' === 'true',
                latencyAlert: '{{latencyAlert}}' === 'true'
            };

            console.log('Initial Data:', initialData);

            // Theme Toggle
            const themeToggle = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.dataset.theme = savedTheme;
            themeToggle.textContent = savedTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
                document.documentElement.dataset.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                tippy('[data-tippy-content]').forEach(t => t.setProps({ theme: newTheme }));
                themeToggle.textContent = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
                trendChart.update();
                statusChart.update();
            });

            // Tooltips
            tippy('[data-tippy-content]', { theme: savedTheme, placement: 'top', delay: [200, 0] });

            // Trend Chart
            const trendChartCtx = document.getElementById('trendChart').getContext('2d');
            const trendChart = new Chart(trendChartCtx, {
                type: 'line',
                data: {
                    labels: initialData.trends.map(t => new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })),
                    datasets: [
                        {
                            label: 'Ingestion Rate',
                            data: initialData.trends.map(t => t.ingestionRate || 0),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Queue Size',
                            data: initialData.trends.map(t => t.queueSize || 0),
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Avg Latency',
                            data: initialData.trends.map(t => t.avgLatency || 0),
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { display: false },
                            title: { display: true, text: 'Time', font: { size: 14, weight: '600' } }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            title: { display: true, text: 'Rate/Latency', font: { size: 14, weight: '600' } },
                            position: 'left'
                        },
                        y1: {
                            beginAtZero: true,
                            grid: { display: false },
                            title: { display: true, text: 'Queue Size', font: { size: 14, weight: '600' } },
                            position: 'right'
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { padding: 20, font: { size: 12 } } },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 12 },
                            padding: 10
                        },
                        title: {
                            display: initialData.trends.length === 0,
                            text: 'No Performance Data Available',
                            font: { size: 16 },
                            padding: 20
                        }
                    }
                }
            });

            // Status Chart
            const statusChartCtx = document.getElementById('statusChart').getContext('2d');
            const statusChart = new Chart(statusChartCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(initialData.statusCounts),
                    datasets: [{
                        data: Object.values(initialData.statusCounts),
                        backgroundColor: ['#22c55e', '#ef4444', '#3b82f6'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, font: { size: 12 } } },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 12 },
                            padding: 10
                        },
                        title: {
                            display: Object.keys(initialData.statusCounts).length === 0,
                            text: 'No Status Data Available',
                            font: { size: 16 },
                            padding: 20
                        }
                    }
                }
            });

            // Alert Management
            function showAlert(message) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <p>${message}</p>
                    <button onclick="this.parentElement.remove()">Dismiss</button>
                `;
                document.body.appendChild(alert);
                setTimeout(() => alert.remove(), 5000);
            }

            // Table Population with Pagination and Filtering
            function populateTable(tableId, data, filterId, paginationId, startId, endId, itemsPerPage = 5, rowFn) {
                const table = document.getElementById(tableId);
                const filter = document.getElementById(filterId);
                const startFilter = document.getElementById(startId);
                const endFilter = document.getElementById(endId);
                const pagination = document.getElementById(paginationId);
                let filteredData = [...data];
                let currentPage = 1;

                const render = () => {
                    const start = (currentPage - 1) * itemsPerPage;
                    const end = Math.min(start + itemsPerPage, filteredData.length);
                    table.innerHTML = filteredData.length === 0 ? '<tr><td colspan="100%">No data available</td></tr>' : '';
                    filteredData.slice(start, end).forEach(item => {
                        const row = document.createElement('tr');
                        row.classList.add('fade-in');
                        row.innerHTML = rowFn(item);
                        table.appendChild(row);
                    });
                    pagination.innerHTML = '';
                    const pageCount = Math.ceil(filteredData.length / itemsPerPage);
                    if (pageCount > 1) {
                        for (let i = 1; i <= pageCount; i++) {
                            const btn = document.createElement('button');
                            btn.textContent = i;
                            btn.disabled = i === currentPage;
                            btn.addEventListener('click', () => { currentPage = i; render(); });
                            pagination.appendChild(btn);
                        }
                    }
                };

                const applyFilters = () => {
                    filteredData = data.filter(item => {
                        const textMatch = Object.values(item).some(v => 
                            v?.toString().toLowerCase().includes(filter.value.toLowerCase()) || false
                        );
                        const startTime = startFilter.value ? new Date(startFilter.value).getTime() : -Infinity;
                        const endTime = endFilter.value ? new Date(endFilter.value).getTime() : Infinity;
                        const itemTime = item.timestamp ? new Date(item.timestamp).getTime() : 0;
                        return textMatch && itemTime >= startTime && itemTime <= endTime;
                    });
                    currentPage = 1;
                    render();
                };

                filter.addEventListener('input', applyFilters);
                startFilter.addEventListener('change', applyFilters);
                endFilter.addEventListener('change', applyFilters);
                render();
            }

            populateTable('status-table', initialData.recentStatuses, 'status-filter', 'status-pagination', 'status-start', 'status-end', 5, s => `
                <td>${s.id?.substring(0, 8) || 'N/A'}...</td>
                <td>${s.status || 'N/A'}</td>
            `);
            populateTable('records-table', initialData.recentRecords, 'records-filter', 'records-pagination', 'records-start', 'records-end', 5, r => `
                <td>${r.projectId || 'N/A'}</td>
                <td>${r.id?.substring(0, 8) || 'N/A'}...</td>
                <td>${r.timestamp ? new Date(r.timestamp).toLocaleString() : 'N/A'}</td>
                <td>${r.durationNs ? (parseInt(r.durationNs) / 1000000).toFixed(2) : 'N/A'}</td>
            `);

            // Refresh Dashboard
            const refreshBtn = document.getElementById('refresh-btn');
            async function refreshDashboard() {
                try {
                    refreshBtn.disabled = true;
                    const start = document.getElementById('trend-start').value;
                    const end = document.getElementById('trend-end').value;
                    const url = `/dashboard${start || end ? '?' : ''}${start ? `start=${start}&` : ''}${end ? `end=${end}` : ''}`.replace(/&$/, '');
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const doc = new DOMParser().parseFromString(await response.text(), 'text/html');
                    const scriptContent = doc.querySelector('script')?.textContent || '';

                    // Update Stats
                    const stats = [
                        { id: 'uptime', trendId: 'uptime-trend', format: v => `${Math.floor(v / 3600).toString().padStart(2, '0')}:${Math.floor((v % 3600) / 60).toString().padStart(2, '0')}:${Math.floor(v % 60).toString().padStart(2, '0')}` },
                        { id: 'http_requests', trendId: 'requests-trend', format: v => v.toFixed(0) },
                        { id: 'queue_size', trendId: 'queue-trend', format: v => v.toFixed(0), alertId: 'queueAlert' },
                        { id: 'db_status', trendId: null, format: v => v },
                        { id: 'ingestion_rate', trendId: 'ingestion-trend', format: v => v.toFixed(2) },
                        { id: 'avg_latency', trendId: 'latency-trend', format: v => v.toFixed(2), alertId: 'latencyAlert' }
                    ];

                    stats.forEach(stat => {
                        const el = document.getElementById(stat.id);
                        const newValue = stat.id === 'db_status' ? doc.getElementById(stat.id)?.textContent || 'N/A' : parseFloat(doc.getElementById(stat.id)?.textContent) || 0;
                        const oldValue = stat.id === 'db_status' ? el.textContent : parseFloat(el.textContent) || 0;

                        if (stat.id === 'db_status') {
                            el.textContent = newValue;
                            el.className = newValue === 'success' ? 'success' : 'error';
                        } else {
                            el.textContent = stat.format(newValue);
                            if (stat.trendId) {
                                const trendEl = document.getElementById(stat.trendId);
                                const diff = newValue - prevData[stat.id];
                                const percentChange = prevData[stat.id] ? (diff / prevData[stat.id] * 100).toFixed(1) : 0;
                                trendEl.textContent = diff !== 0 ? `${percentChange}%` : 'Stable';
                                trendEl.className = `trend ${diff > 0 ? 'up' : diff < 0 ? 'down' : ''}`;
                                if (stat.alertId) {
                                    const alert = scriptContent.includes(`{{${stat.alertId}}}"true`);
                                    if (alert && !prevData[stat.alertId]) {
                                        showAlert(`Alert: ${stat.id === 'queue_size' ? 'Queue Size' : 'Avg Latency'} exceeded threshold!`);
                                    }
                                    el.className = alert ? 'warning' : '';
                                    prevData[stat.alertId] = alert;
                                }
                                prevData[stat.id] = newValue;
                            }
                        }
                    });

                    // Update Charts
                    const newData = {
                        trends: JSON.parse(scriptContent.match(/const trends = (.+?);/)?.[1] || '[]'),
                        statusCounts: JSON.parse(scriptContent.match(/const statusCounts = (.+?);/)?.[1] || '{"Success": 0, "Failed": 0, "Pending": 0}'),
                        recentStatuses: JSON.parse(scriptContent.match(/const recentStatuses = (.+?);/)?.[1] || '[]'),
                        recentRecords: JSON.parse(scriptContent.match(/const recentRecords = (.+?);/)?.[1] || '[]')
                    };

                    // Update Trend Chart
                    trendChart.data.labels = newData.trends.map(t => new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    trendChart.data.datasets[0].data = newData.trends.map(t => t.ingestionRate || 0);
                    trendChart.data.datasets[1].data = newData.trends.map(t => t.queueSize || 0);
                    trendChart.data.datasets[2].data = newData.trends.map(t => t.avgLatency || 0);
                    trendChart.options.plugins.title.display = newData.trends.length === 0;
                    trendChart.update({ duration: 500, easing: 'easeOutQuad' });

                    // Update Status Chart
                    statusChart.data.labels = Object.keys(newData.statusCounts);
                    statusChart.data.datasets[0].data = Object.values(newData.statusCounts);
                    statusChart.data.datasets[0].backgroundColor = Object.keys(newData.statusCounts).length ? ['#22c55e', '#ef4444', '#3b82f6'] : ['#d1d5db'];
                    statusChart.options.plugins.title.display = Object.keys(newData.statusCounts).length === 0;
                    statusChart.update({ duration: 500, easing: 'easeOutQuad' });

                    // Update Tables
                    populateTable('status-table', newData.recentStatuses, 'status-filter', 'status-pagination', 'status-start', 'status-end', 5, s => `
                        <td>${s.id?.substring(0, 8) || 'N/A'}...</td>
                        <td>${s.status || 'N/A'}</td>
                    `);
                    populateTable('records-table', newData.recentRecords, 'records-filter', 'records-pagination', 'records-start', 'records-end', 5, r => `
                        <td>${r.projectId || 'N/A'}</td>
                        <td>${r.id?.substring(0, 8) || 'N/A'}...</td>
                        <td>${r.timestamp ? new Date(r.timestamp).toLocaleString() : 'N/A'}</td>
                        <td>${r.durationNs ? (parseInt(r.durationNs) / 1000000).toFixed(2) : 'N/A'}</td>
                    `);
                } catch (error) {
                    console.error('Refresh failed:', error);
                    showAlert('Failed to refresh dashboard');
                } finally {
                    refreshBtn.disabled = false;
                }
            }

            refreshBtn.addEventListener('click', refreshDashboard);
            setInterval(refreshDashboard, 10000);

            // Date Range Filters
            const applyDateFilter = (startId, endId) => {
                const start = document.getElementById(startId);
                const end = document.getElementById(endId);
                const update = () => refreshDashboard();
                start.addEventListener('change', update);
                end.addEventListener('change', update);
            };
            applyDateFilter('trend-start', 'trend-end');
            applyDateFilter('status-start', 'status-end');
            applyDateFilter('records-start', 'records-end');

            // Export CSV
            document.getElementById('export-btn').addEventListener('click', () => {
                const start = document.getElementById('records-start').value;
                const end = document.getElementById('records-end').value;
                const url = `/export_records${start || end ? '?' : ''}${start ? `start=${start}&` : ''}${end ? `end=${end}` : ''}`.replace(/&$/, '');
                window.location.href = url;
            });
        });
    </script>
</body>
</html>