<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeFusion Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6/themes/light.css">
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #357abd;
            --text: #1f2937;
            --bg: #f9fafb;
            --card-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --success: #16a34a;
            --warning: #f59e0b;
            --error: #dc2626;
            --muted: #6b7280;
            --border: #e5e7eb;
            --alert-bg: #fef3c7;
            --alert-border: #d97706;
        }
        [data-theme="dark"] {
            --primary: #60a5fa;
            --secondary: #3b82f6;
            --text: #d1d5db;
            --bg: #111827;
            --card-bg: #1f2a44;
            --shadow: rgba(0, 0, 0, 0.3);
            --muted: #9ca3af;
            --border: #374151;
            --warning: #d97706;
            --alert-bg: #713f12;
            --alert-border: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body {
            background: var(--bg);
            color: var(--text);
            padding: 1.5rem;
            line-height: 1.5;
            transition: background 0.3s ease, color 0.3s ease;
        }
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        header .controls {
            display: flex;
            gap: 0.75rem;
        }
        header button {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.2s;
        }
        header button:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        header button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        .stat-card h2 {
            font-size: 0.875rem;
            color: var(--muted);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .stat-card p {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .stat-card p.success { color: var(--success); }
        .stat-card p.warning { color: var(--warning); }
        .stat-card p.error { color: var(--error); }
        .stat-card .trend {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            color: var(--muted);
        }
        .stat-card .trend.up::before { content: "▲ "; color: var(--success); }
        .stat-card .trend.down::before { content: "▼ "; color: var(--error); }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 1.5rem;
        }
        .chart-container, .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow);
            position: relative;
        }
        .chart-container h2, .table-container h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .filter-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        input[type="datetime-local"] {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.875rem;
        }
        input[type="text"] {
            width: 100%;
            padding: 0.5rem 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.875rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        .pagination {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }
        .pagination button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        .pagination button:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }
        .pagination button:hover:not(:disabled) {
            background: var(--secondary);
        }
        .export-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        .export-btn:hover {
            background: var(--secondary);
        }
        footer {
            text-align: center;
            padding: 1rem;
            color: var(--muted);
            font-size: 0.75rem;
        }
        .alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--alert-bg);
            border: 1px solid var(--alert-border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px var(--shadow);
            max-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        .alert p {
            font-size: 0.875rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .alert button {
            background: var(--warning);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
        }
        .alert button:hover {
            background: var(--secondary);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @media (max-width: 768px) {
            body { padding: 1rem; }
            header { flex-direction: column; padding: 1rem; }
            header h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
            .controls { margin-top: 1rem; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            .charts-grid, .tables-grid { grid-template-columns: 1fr; }
            .filter-container { flex-direction: column; }
            .alert { max-width: 90%; right: 0.5rem; top: 0.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>TimeFusion Dashboard</h1>
        <div class="controls">
            <button id="refresh-btn">Refresh</button>
            <button id="theme-toggle">Dark Mode</button>
        </div>
    </header>
    <main>
        <section class="stats-grid">
            <div class="stat-card" data-tippy-content="Application uptime in seconds">
                <h2>Uptime</h2>
                <p id="uptime">{{uptime}}</p>
                <span class="trend" id="uptime-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Total HTTP requests processed">
                <h2>Requests</h2>
                <p id="http_requests">{{http_requests}}</p>
                <span class="trend" id="requests-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Current ingestion queue size (Alert > 50)">
                <h2>Queue Size</h2>
                <p id="queue_size" class="{{queue_alert ? 'warning' : ''}}">{{queue_size}}</p>
                <span class="trend" id="queue-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Database health status">
                <h2>DB Status</h2>
                <p id="db_status" class="{{db_status}}">{{db_status}}</p>
            </div>
            <div class="stat-card" data-tippy-content="Ingestion rate (records/sec)">
                <h2>Ingestion Rate</h2>
                <p id="ingestion_rate">{{ingestion_rate}}</p>
                <span class="trend" id="ingestion-trend"></span>
            </div>
            <div class="stat-card" data-tippy-content="Average latency in milliseconds (Alert > 200ms)">
                <h2>Avg Latency</h2>
                <p id="avg_latency" class="{{latency_alert ? 'warning' : ''}}">{{avg_latency}}</p>
                <span class="trend" id="latency-trend"></span>
            </div>
        </section>
        <section class="charts-grid">
            <div class="chart-container">
                <h2>Performance Trends</h2>
                <div class="filter-container">
                    <input type="datetime-local" id="trend-start" step="1">
                    <input type="datetime-local" id="trend-end" step="1">
                </div>
                <canvas id="trendChart" style="height: 300px;"></canvas>
            </div>
            <div class="chart-container">
                <h2>Ingestion Status</h2>
                <canvas id="statusChart" style="height: 300px;"></canvas>
            </div>
        </section>
        <section class="tables-grid">
            <div class="table-container">
                <h2>Recent Ingestion Statuses</h2>
                <div class="filter-container">
                    <input type="datetime-local" id="status-start" step="1">
                    <input type="datetime-local" id="status-end" step="1">
                </div>
                <input type="text" id="status-filter" placeholder="Filter by ID or Status">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="status-table"></tbody>
                </table>
                <div class="pagination" id="status-pagination"></div>
            </div>
            <div class="table-container">
                <h2>Recent Records</h2>
                <div class="filter-container">
                    <input type="datetime-local" id="records-start" step="1">
                    <input type="datetime-local" id="records-end" step="1">
                </div>
                <input type="text" id="records-filter" placeholder="Filter by Project ID or Timestamp">
                <table>
                    <thead>
                        <tr>
                            <th>Project ID</th>
                            <th>Record ID</th>
                            <th>Timestamp</th>
                            <th>Latency (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="records-table"></tbody>
                </table>
                <div class="pagination" id="records-pagination"></div>
                <button class="export-btn" id="export-btn">Export CSV</button>
            </div>
        </section>
    </main>
    <footer>
        <p>© 2025 TimeFusion</p>
    </footer>

    <script>
        const initialData = {
            recentStatuses: JSON.parse('{{recent_statuses}}'),
            recentRecords: JSON.parse('{{recent_records}}'),
            statusCounts: JSON.parse('{{status_counts}}'),
            trends: JSON.parse('{{trends}}')
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Persistent state for trends and alerts
            let prevData = {
                uptime: parseFloat('{{uptime}}') || 0,
                http_requests: parseFloat('{{http_requests}}') || 0,
                queue_size: parseFloat('{{queue_size}}') || 0,
                ingestion_rate: parseFloat('{{ingestion_rate}}') || 0,
                avg_latency: parseFloat('{{avg_latency}}') || 0,
                queue_alert: '{{queue_alert}}' === 'true',
                latency_alert: '{{latency_alert}}' === 'true'
            };

            // Theme Toggle
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
                document.documentElement.dataset.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                tippy('[data-tippy-content]').forEach(t => t.setProps({ theme: newTheme }));
                themeToggle.textContent = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
            });
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.dataset.theme = savedTheme;
            themeToggle.textContent = savedTheme === 'dark' ? 'Light Mode' : 'Dark Mode';

            // Tooltips
            tippy('[data-tippy-content]', { theme: savedTheme, placement: 'top', delay: [200, 0] });

            // Trend Chart (Line with multiple datasets)
            const trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: initialData.trends.map(t => new Date(t.timestamp).toLocaleTimeString()),
                    datasets: [
                        {
                            label: 'Ingestion Rate',
                            data: initialData.trends.map(t => t.ingestion_rate),
                            borderColor: '#4a90e2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Queue Size',
                            data: initialData.trends.map(t => t.queue_size),
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Avg Latency',
                            data: initialData.trends.map(t => t.avg_latency),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Time', font: { size: 12 } } },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Rate/Latency', font: { size: 12 } },
                            position: 'left'
                        },
                        y1: {
                            beginAtZero: true,
                            title: { display: true, text: 'Queue Size', font: { size: 12 } },
                            position: 'right'
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { padding: 15, font: { size: 12 } } },
                        title: { display: false }
                    }
                }
            });

            // Status Chart (Doughnut)
            const statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(initialData.statusCounts),
                    datasets: [{
                        data: Object.values(initialData.statusCounts),
                        backgroundColor: ['#16a34a', '#dc2626', '#4a90e2'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                        title: { display: false }
                    }
                }
            });

            // Alert Management
            function showAlert(message) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = `
                    <p>${message}</p>
                    <button onclick="this.parentElement.remove()">Dismiss</button>
                `;
                document.body.appendChild(alert);
                setTimeout(() => alert.remove(), 5000); // Auto-dismiss after 5s
            }

            // Table Population with Pagination and Filtering
            function populateTable(tableId, data, filterId, paginationId, startId, endId, itemsPerPage = 5, rowFn) {
                const table = document.getElementById(tableId);
                const filter = document.getElementById(filterId);
                const startFilter = document.getElementById(startId);
                const endFilter = document.getElementById(endId);
                const pagination = document.getElementById(paginationId);
                let filteredData = [...data];
                let currentPage = 1;

                const render = () => {
                    const start = (currentPage - 1) * itemsPerPage;
                    const end = Math.min(start + itemsPerPage, filteredData.length);
                    table.innerHTML = '';
                    filteredData.slice(start, end).forEach(item => {
                        const row = document.createElement('tr');
                        row.classList.add('fade-in');
                        row.innerHTML = rowFn(item);
                        table.appendChild(row);
                    });
                    pagination.innerHTML = '';
                    const pageCount = Math.ceil(filteredData.length / itemsPerPage);
                    if (pageCount > 1) {
                        for (let i = 1; i <= pageCount; i++) {
                            const btn = document.createElement('button');
                            btn.textContent = i;
                            btn.disabled = i === currentPage;
                            btn.addEventListener('click', () => { currentPage = i; render(); });
                            pagination.appendChild(btn);
                        }
                    }
                };

                const applyFilters = () => {
                    filteredData = data.filter(item => {
                        const textMatch = Object.values(item).some(v => 
                            v.toString().toLowerCase().includes(filter.value.toLowerCase())
                        );
                        const startTime = startFilter.value ? new Date(startFilter.value).getTime() : -Infinity;
                        const endTime = endFilter.value ? new Date(endFilter.value).getTime() : Infinity;
                        const itemTime = item.timestamp ? new Date(item.timestamp).getTime() : 0;
                        return textMatch && itemTime >= startTime && itemTime <= endTime;
                    });
                    currentPage = 1;
                    render();
                };

                filter.addEventListener('input', applyFilters);
                startFilter.addEventListener('change', applyFilters);
                endFilter.addEventListener('change', applyFilters);
                render();
            }

            populateTable('status-table', initialData.recentStatuses, 'status-filter', 'status-pagination', 'status-start', 'status-end', 5, s => `
                <td>${s.id.substring(0, 8)}...</td>
                <td>${s.status}</td>
            `);
            populateTable('records-table', initialData.recentRecords, 'records-filter', 'records-pagination', 'records-start', 'records-end', 5, r => `
                <td>${r.project_id}</td>
                <td>${r.id.substring(0, 8)}...</td>
                <td>${new Date(r.timestamp).toLocaleString()}</td>
                <td>${(parseInt(r.duration_ns) / 1000000).toFixed(2)}</td>
            `);

            // Refresh Button and Data Updates
            const refreshBtn = document.getElementById('refresh-btn');
            async function refreshDashboard() {
                try {
                    refreshBtn.disabled = true;
                    const start = document.getElementById('trend-start').value;
                    const end = document.getElementById('trend-end').value;
                    const url = `/dashboard${start || end ? '?' : ''}${start ? `start=${start}&` : ''}${end ? `end=${end}` : ''}`.replace(/&$/, '');
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const doc = new DOMParser().parseFromString(await response.text(), 'text/html');

                    // Update stats with comparison
                    const stats = [
                        { id: 'uptime', trendId: 'uptime-trend', format: v => `${Math.floor(v / 3600)}h ${Math.floor((v % 3600) / 60)}m` },
                        { id: 'http_requests', trendId: 'requests-trend', format: v => v.toFixed(0) },
                        { id: 'queue_size', trendId: 'queue-trend', format: v => v.toFixed(0), alertId: 'queue_alert' },
                        { id: 'db_status', trendId: null, format: v => v },
                        { id: 'ingestion_rate', trendId: 'ingestion-trend', format: v => v.toFixed(2) },
                        { id: 'avg_latency', trendId: 'latency-trend', format: v => v.toFixed(2), alertId: 'latency_alert' }
                    ];

                    stats.forEach(stat => {
                        const el = document.getElementById(stat.id);
                        const newValue = stat.id === 'db_status' ? doc.getElementById(stat.id)?.textContent || 'N/A' : parseFloat(doc.getElementById(stat.id)?.textContent) || 0;
                        const oldValue = stat.id === 'db_status' ? el.textContent : parseFloat(el.textContent) || 0;
                        
                        if (stat.id === 'db_status') {
                            el.textContent = newValue;
                            el.className = newValue === 'success' ? 'success' : 'error';
                        } else {
                            el.textContent = stat.format(newValue);
                            if (stat.trendId) {
                                const trendEl = document.getElementById(stat.trendId);
                                const diff = newValue - prevData[stat.id];
                                const percentChange = prevData[stat.id] ? (diff / prevData[stat.id] * 100).toFixed(1) : 0;
                                trendEl.textContent = diff !== 0 ? `${percentChange}%` : 'No change';
                                trendEl.className = `trend ${diff > 0 ? 'up' : diff < 0 ? 'down' : ''}`;
                                if (stat.alertId) {
                                    const alert = doc.querySelector('script').textContent.includes(`{{${stat.alertId}}}"true`);
                                    if (alert && !prevData[stat.alertId]) {
                                        showAlert(`Alert: ${stat.id === 'queue_size' ? 'Queue Size' : 'Avg Latency'} exceeded threshold!`);
                                    }
                                    el.className = alert ? 'warning' : '';
                                    prevData[stat.alertId] = alert;
                                }
                                prevData[stat.id] = newValue;
                            }
                        }
                    });

                    // Update trend chart
                    const newTrends = JSON.parse(doc.querySelector('script').textContent.match(/const trends = (.+?);/)[1]);
                    trendChart.data.labels = newTrends.map(t => new Date(t.timestamp).toLocaleTimeString());
                    trendChart.data.datasets[0].data = newTrends.map(t => t.ingestion_rate);
                    trendChart.data.datasets[1].data = newTrends.map(t => t.queue_size);
                    trendChart.data.datasets[2].data = newTrends.map(t => t.avg_latency);
                    trendChart.update({ duration: 300, easing: 'easeOutQuad' });

                    // Update status chart
                    const newStatusCounts = JSON.parse(doc.querySelector('script').textContent.match(/const statusCounts = (.+?);/)[1]);
                    statusChart.data.labels = Object.keys(newStatusCounts);
                    statusChart.data.datasets[0].data = Object.values(newStatusCounts);
                    statusChart.update({ duration: 300, easing: 'easeOutQuad' });

                    // Update tables
                    const newStatuses = JSON.parse(doc.querySelector('script').textContent.match(/const recentStatuses = (.+?);/)[1]);
                    const newRecords = JSON.parse(doc.querySelector('script').textContent.match(/const recentRecords = (.+?);/)[1]);
                    populateTable('status-table', newStatuses, 'status-filter', 'status-pagination', 'status-start', 'status-end', 5, s => `
                        <td>${s.id.substring(0, 8)}...</td>
                        <td>${s.status}</td>
                    `);
                    populateTable('records-table', newRecords, 'records-filter', 'records-pagination', 'records-start', 'records-end', 5, r => `
                        <td>${r.project_id}</td>
                        <td>${r.id.substring(0, 8)}...</td>
                        <td>${new Date(r.timestamp).toLocaleString()}</td>
                        <td>${(parseInt(r.duration_ns) / 1000000).toFixed(2)}</td>
                    `);
                } catch (error) {
                    console.error('Refresh failed:', error);
                } finally {
                    refreshBtn.disabled = false;
                }
            }

            refreshBtn.addEventListener('click', refreshDashboard);
            setInterval(refreshDashboard, 10000); // Auto-refresh every 10 seconds

            // Date Range Filter Application
            const applyDateFilter = (startId, endId, chart) => {
                const start = document.getElementById(startId);
                const end = document.getElementById(endId);
                const update = () => refreshDashboard();
                start.addEventListener('change', update);
                end.addEventListener('change', update);
            };
            applyDateFilter('trend-start', 'trend-end', trendChart);
            applyDateFilter('status-start', 'status-end', null);
            applyDateFilter('records-start', 'records-end', null);

            // Export CSV
            document.getElementById('export-btn').addEventListener('click', () => {
                const start = document.getElementById('records-start').value;
                const end = document.getElementById('records-end').value;
                const url = `/export_records${start || end ? '?' : ''}${start ? `start=${start}&` : ''}${end ? `end=${end}` : ''}`.replace(/&$/, '');
                window.location.href = url;
            });
        });
    </script>
</body>
</html>